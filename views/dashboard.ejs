
<head>
    <link rel="stylesheet" href="/dashboardstyle.css">
</head>

<div class="dashboard-container">
    <div class="card-wrapper" id="ordersCardWrapper">
        <div class="card-header-controls">
            <h2 class="card-title">Recent Orders</h2>
            <div class="size-control">
                <label for="ordersCardSize">Size:</label>
                <select id="ordersCardSize" onchange="adjustCardSize('ordersCardWrapper', this.value)">
                    <option value="small">Small</option>
                    <option value="medium" selected>Medium</option>
                    <option value="large">Large</option>
                </select>
            </div>
        </div>
        <div class="cards-grid">
            <div class="card">
                <div class="card-field">
                    <span class="field-label">Date:</span>
                    <span class="field-value">TEST</span>
                </div>
                <div class="card-field">
                    <span class="field-label">Vendor:</span>
                    <span class="field-value">TEST2</span>
                </div>
                <div class="card-field">
                    <span class="field-label">Items:</span>
                    <span class="field-value">TEST3</span>
                </div>
                <div class="card-field">
                    <span class="field-label">Quantity:</span>
                    <span class="field-value">45</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card-wrapper" id="inventoryCardWrapper">
        <div class="card-header-controls">
            <h2 class="card-title">Need to Order</h2>
            <div class="size-control">
                <label for="inventoryCardSize">Size:</label>
                <select id="inventoryCardSize" onchange="adjustCardSize('inventoryCardWrapper', this.value)">
                    <option value="small">Small</option>
                    <option value="medium" selected>Medium</option>
                    <option value="large">Large</option>
                </select>
            </div>
        </div>
        <div class="cards-grid">
            <% if (lowInventoryItems && lowInventoryItems.length > 0) { %>
                <% lowInventoryItems.forEach(item => { %>
                    <div class="card">
                        <div class="card-field">
                            <span class="field-label">Item:</span>
                            <span class="field-value"><%= item.item %></span>
                        </div>
                        <div class="card-field">
                            <span class="field-label">Brand:</span>
                            <span class="field-value"><%= item.brand || 'N/A' %></span>
                        </div>
                        <div class="card-field">
                            <span class="field-label">Catalog:</span>
                            <span class="field-value"><%= item.catalog || 'N/A' %></span>
                        </div>
                        <div class="card-field">
                            <span class="field-label">Current Qty:</span>
                            <span class="field-value quantity-low"><%= item.currentquantity %></span>
                        </div>
                        <div class="card-field">
                            <span class="field-label">Min Qty:</span>
                            <span class="field-value"><%= item.minimumquantity %></span>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="empty-state">No items need to be ordered</div>
            <% } %>
        </div>
    </div>

    <div class="card-wrapper cycle-count-wrapper" id="cycleCountCardWrapper">
        <div class="card-header-controls">
            <h2 class="card-title">Cycle Counts Due</h2>
            <div class="controls-group">
                <div class="size-control">
                    <label for="cycleCountCardSize">Size:</label>
                    <select id="cycleCountCardSize" onchange="adjustCardSize('cycleCountCardWrapper', this.value)">
                        <option value="small">Small</option>
                        <option value="medium" selected>Medium</option>
                        <option value="large">Large</option>
                    </select>
                </div>
                <div class="display-limit-control">
                    <label for="cycleCountLimit">Show:</label>
                    <select id="cycleCountLimit" onchange="updateCycleCountDisplay()">
                        <option value="5">5 items</option>
                        <option value="10" selected>10 items</option>
                        <option value="15">15 items</option>
                        <option value="20">20 items</option>
                        <option value="all">All items</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="cards-grid" id="cycleCountCardsContainer">
            <% if (cycleCountDueItems && cycleCountDueItems.length > 0) { %>
                <% cycleCountDueItems.forEach((item, index) => { %>
                    <div class="card cycle-count-card" data-index="<%= index %>" data-item-id="<%= item._id %>" data-current-qty="<%= item.currentquantity %>">
                        <div class="card-field">
                            <span class="field-label">Item:</span>
                            <span class="field-value"><%= item.item %></span>
                        </div>
                        <div class="card-field">
                            <span class="field-label">Brand:</span>
                            <span class="field-value"><%= item.brand || 'N/A' %></span>
                        </div>
                        <div class="card-field">
                            <span class="field-label">Last Count:</span>
                            <span class="field-value"><%= item.lastCycleCount ? new Date(item.lastCycleCount).toLocaleDateString() : 'Never' %></span>
                        </div>
                        <div class="card-field">
                            <span class="field-label">Days Since:</span>
                            <span class="field-value"><%= item.daysSinceCount !== null ? item.daysSinceCount : 'N/A' %></span>
                        </div>
                        <div class="card-field">
                            <span class="field-label">Interval:</span>
                            <span class="field-value"><%= item.cycleCountInterval || 90 %> days</span>
                        </div>
                        <div class="card-field">
                            <span class="field-label">Status:</span>
                            <span class="field-value">
                                <% if (!item.lastCycleCount) { %>
                                    <span class="status-badge status-overdue">Never Counted</span>
                                <% } else if (item.daysOverdue > 0) { %>
                                    <span class="status-badge status-overdue">Overdue by <%= item.daysOverdue %> days</span>
                                <% } else { %>
                                    <span class="status-badge status-due">Due Now</span>
                                <% } %>
                            </span>
                        </div>
                        <div class="card-action">
                            <button class="cycle-count-update-btn" onclick="openCycleCountModal('<%= item._id %>', '<%= item.item %>', '<%= item.currentquantity %>')">
                                Update Count
                            </button>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="empty-state">No cycle counts due</div>
            <% } %>
        </div>
    </div>
</div>

<!-- Cycle Count Update Modal -->
<div id="cycleCountModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeCycleCountModal()">&times;</span>
        <h2>Update Cycle Count</h2>
        <div class="modal-body">
            <p><strong>Item:</strong> <span id="modalItemName"></span></p>
            <div class="form-group">
                <label for="currentQty">Current Quantity:</label>
                <input type="number" id="currentQty" readonly>
            </div>
            <div class="form-group">
                <label for="updatedQty">Updated Quantity:</label>
                <input type="number" id="updatedQty" placeholder="Enter counted quantity" required>
            </div>
            <div class="modal-buttons">
                <button class="btn-submit" onclick="submitCycleCount()">Submit</button>
                <button class="btn-cancel" onclick="closeCycleCountModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentItemId = null;

function adjustCardSize(wrapperId, size) {
    const wrapper = document.getElementById(wrapperId);

    // Remove existing size classes
    wrapper.classList.remove('card-size-small', 'card-size-medium', 'card-size-large');

    // Add new size class
    wrapper.classList.add('card-size-' + size);

    // Save preference to localStorage
    localStorage.setItem(wrapperId + '-size', size);
}

function updateCycleCountDisplay() {
    const limit = document.getElementById('cycleCountLimit').value;
    const cards = document.querySelectorAll('.cycle-count-card');

    cards.forEach((card, index) => {
        if (limit === 'all') {
            card.style.display = '';
        } else {
            const limitNum = parseInt(limit);
            card.style.display = index < limitNum ? '' : 'none';
        }
    });
}

function openCycleCountModal(itemId, itemName, currentQty) {
    currentItemId = itemId;
    document.getElementById('modalItemName').textContent = itemName;
    document.getElementById('currentQty').value = currentQty;
    document.getElementById('updatedQty').value = '';
    document.getElementById('cycleCountModal').style.display = 'block';
}

function closeCycleCountModal() {
    document.getElementById('cycleCountModal').style.display = 'none';
    currentItemId = null;
}

async function submitCycleCount() {
    const updatedQty = document.getElementById('updatedQty').value;

    if (!updatedQty || updatedQty === '') {
        alert('Please enter an updated quantity');
        return;
    }

    try {
        const response = await fetch('/update-cycle-count', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                itemId: currentItemId,
                newQuantity: parseInt(updatedQty),
                date: new Date().toISOString()
            })
        });


        if (response.ok) {
            alert('Cycle count updated successfully!');

            // Remove the card from the DOM
            const card = document.querySelector(`.cycle-count-card[data-item-id="${currentItemId}"]`);
            if (card) {
                card.remove();

                // Check if there are any cards left
                const remainingCards = document.querySelectorAll('.cycle-count-card');
                if (remainingCards.length === 0) {
                    // Show empty state message
                    const container = document.getElementById('cycleCountCardsContainer');
                    container.innerHTML = '<div class="empty-state">No cycle counts due</div>';
                }
            }

            closeCycleCountModal();
        } else {
            const error = await response.json();
            alert('Failed to update cycle count: ' + (error.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error updating cycle count:', error);
        alert('Error updating cycle count');
    }
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('cycleCountModal');
    if (event.target == modal) {
        closeCycleCountModal();
    }
}

// Initialize display and restore saved sizes on page load
document.addEventListener('DOMContentLoaded', function() {
    updateCycleCountDisplay();

    // Restore saved card sizes from localStorage
    const cardWrappers = ['ordersCardWrapper', 'inventoryCardWrapper', 'cycleCountCardWrapper'];
    cardWrappers.forEach(wrapperId => {
        const savedSize = localStorage.getItem(wrapperId + '-size');
        if (savedSize) {
            const wrapper = document.getElementById(wrapperId);
            const select = wrapper.querySelector('select[id$="CardSize"]');
            if (select && wrapper) {
                select.value = savedSize;
                wrapper.classList.add('card-size-' + savedSize);
            }
        } else {
            // Apply default medium size
            const wrapper = document.getElementById(wrapperId);
            if (wrapper) {
                wrapper.classList.add('card-size-medium');
            }
        }
    });
});
</script>
